# Governance Check Workflow
# Validates governance compliance on pull requests

name: Governance Check

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  governance-validation:
    name: Validate Governance Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Governance CLI
        run: npm install -g @trevorplam/governance-cli
      
      - name: Validate Governance Configuration
        id: validate
        run: |
          governance-cli validate --verbose
          echo "validation_result=$?" >> $GITHUB_OUTPUT
      
      - name: Check Boundaries
        if: success() || failure()
        id: boundaries
        run: |
          governance-cli verify --profile=boundaries
          echo "boundary_result=$?" >> $GITHUB_OUTPUT
      
      - name: Verify Manifest
        if: success() || failure()
        id: manifest
        run: |
          governance-cli validate --check=manifest
          echo "manifest_result=$?" >> $GITHUB_OUTPUT
      
      - name: Run Full Verification
        if: success() || failure()
        id: verify
        run: |
          governance-cli verify --profile=ci
          echo "verify_result=$?" >> $GITHUB_OUTPUT
      
      - name: Generate Report
        if: always()
        run: |
          echo "## Governance Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ steps.validate.outputs.validation_result == '0' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Boundaries: ${{ steps.boundaries.outputs.boundary_result == '0' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Manifest: ${{ steps.manifest.outputs.manifest_result == '0' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Full Verification: ${{ steps.verify.outputs.verify_result == '0' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          script: |
            const validation = '${{ steps.validate.outputs.validation_result }}' === '0' ? '‚úÖ Passed' : '‚ùå Failed';
            const boundaries = '${{ steps.boundaries.outputs.boundary_result }}' === '0' ? '‚úÖ Passed' : '‚ùå Failed';
            const manifest = '${{ steps.manifest.outputs.manifest_result }}' === '0' ? '‚úÖ Passed' : '‚ùå Failed';
            const verify = '${{ steps.verify.outputs.verify_result }}' === '0' ? '‚úÖ Passed' : '‚ùå Failed';
            
            const body = `## üîç Governance Check Results
            
            | Check | Status |
            |-------|--------|
            | Validation | ${validation} |
            | Boundaries | ${boundaries} |
            | Manifest | ${manifest} |
            | Full Verification | ${verify} |
            
            ${verify === '‚ùå Failed' ? '‚ö†Ô∏è **Governance checks failed. Please review and fix issues before merging.**' : '‚úÖ **All governance checks passed!**'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Block Merge on Failure
        if: failure()
        run: |
          echo "::error::Governance checks failed. Please fix issues before merging."
          exit 1

# Configuration options:
# - To disable blocking on failure, remove the last step or set continue-on-error: true
# - To run only on specific branches, modify the 'branches' list
# - To run on schedule, add a 'schedule' trigger
# - To customize verification profiles, modify --profile parameter
