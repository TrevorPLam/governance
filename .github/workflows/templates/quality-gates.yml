# Quality Gates Workflow
# Enforces quality standards: tests, coverage, linting, build

name: Quality Gates

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  quality-checks:
    name: Quality Gates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        id: lint
        continue-on-error: true
        run: |
          npm run lint
          echo "lint_result=$?" >> $GITHUB_OUTPUT
      
      - name: Run type check
        id: typecheck
        continue-on-error: true
        run: |
          npm run typecheck || echo "Type check not configured"
          echo "typecheck_result=$?" >> $GITHUB_OUTPUT
      
      - name: Run tests with coverage
        id: test
        continue-on-error: true
        run: |
          npm test -- --coverage --ci
          echo "test_result=$?" >> $GITHUB_OUTPUT
      
      - name: Check coverage thresholds
        id: coverage
        continue-on-error: true
        run: |
          # Extract coverage from coverage/coverage-summary.json if it exists
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
            echo "Coverage: ${COVERAGE}%"
            echo "coverage_pct=${COVERAGE}" >> $GITHUB_OUTPUT
            
            # Check against minimum threshold (default 70%)
            MINIMUM=${MINIMUM_COVERAGE:-70}
            if (( $(echo "$COVERAGE < $MINIMUM" | bc -l) )); then
              echo "::error::Coverage ${COVERAGE}% is below minimum ${MINIMUM}%"
              echo "coverage_result=1" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "coverage_result=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "No coverage report found"
            echo "coverage_result=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Build project
        id: build
        continue-on-error: true
        run: |
          npm run build
          echo "build_result=$?" >> $GITHUB_OUTPUT
      
      - name: Check documentation
        id: docs
        continue-on-error: true
        run: |
          # Check if README exists and is up to date
          if [ ! -f README.md ]; then
            echo "::warning::README.md not found"
            echo "docs_result=1" >> $GITHUB_OUTPUT
          else
            echo "docs_result=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Quality Report
        if: always()
        run: |
          echo "## ğŸ“Š Quality Gates Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ steps.lint.outputs.lint_result == '0' && 'âœ… Passed' || 'âŒ Failed' }} | Code style checks |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ steps.typecheck.outputs.typecheck_result == '0' && 'âœ… Passed' || 'âš ï¸ Skipped' }} | TypeScript validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.test.outputs.test_result == '0' && 'âœ… Passed' || 'âŒ Failed' }} | Unit & integration tests |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.coverage.outputs.coverage_result == '0' && 'âœ… Passed' || 'âŒ Failed' }} | ${{ steps.coverage.outputs.coverage_pct }}% coverage |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outputs.build_result == '0' && 'âœ… Passed' || 'âŒ Failed' }} | Build successful |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ steps.docs.outputs.docs_result == '0' && 'âœ… Passed' || 'âš ï¸ Warning' }} | README exists |" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          script: |
            const lint = '${{ steps.lint.outputs.lint_result }}' === '0' ? 'âœ…' : 'âŒ';
            const test = '${{ steps.test.outputs.test_result }}' === '0' ? 'âœ…' : 'âŒ';
            const coverage = '${{ steps.coverage.outputs.coverage_pct }}';
            const build = '${{ steps.build.outputs.build_result }}' === '0' ? 'âœ…' : 'âŒ';
            
            const body = `## ğŸ“Š Quality Gates Report
            
            | Gate | Status |
            |------|--------|
            | Linting | ${lint} |
            | Tests | ${test} |
            | Coverage | ${coverage}% |
            | Build | ${build} |
            
            ${lint === 'âŒ' || test === 'âŒ' || build === 'âŒ' ? 'âš ï¸ **Some quality gates failed. Please review and fix.**' : 'âœ… **All quality gates passed!**'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Fail if quality gates not met
        if: |
          steps.lint.outputs.lint_result != '0' ||
          steps.test.outputs.test_result != '0' ||
          steps.coverage.outputs.coverage_result != '0' ||
          steps.build.outputs.build_result != '0'
        run: |
          echo "::error::One or more quality gates failed"
          exit 1

# Configuration:
# Set MINIMUM_COVERAGE environment variable to change coverage threshold (default: 70%)
# Customize quality gates by modifying the steps above
# Add additional checks as needed for your project
